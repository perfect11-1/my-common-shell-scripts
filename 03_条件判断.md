# 条件判断详解

## 1. test命令和[]

### 基本语法
```bash
# 三种等价写法
test expression
[ expression ]
[[ expression ]]  # 推荐，功能更强大
```

### 文件测试
```bash
file="/etc/passwd"

# 文件存在性测试
[ -e "$file" ] && echo "文件存在"
[ -f "$file" ] && echo "是普通文件"
[ -d "$file" ] && echo "是目录"
[ -L "$file" ] && echo "是符号链接"
[ -S "$file" ] && echo "是套接字文件"

# 文件权限测试
[ -r "$file" ] && echo "可读"
[ -w "$file" ] && echo "可写"
[ -x "$file" ] && echo "可执行"

# 文件属性测试
[ -s "$file" ] && echo "文件非空"
[ -O "$file" ] && echo "当前用户拥有"
[ -G "$file" ] && echo "当前组拥有"

# 文件比较
file1="file1.txt"
file2="file2.txt"
[ "$file1" -nt "$file2" ] && echo "file1比file2新"
[ "$file1" -ot "$file2" ] && echo "file1比file2旧"
[ "$file1" -ef "$file2" ] && echo "两文件是同一个文件"
```

### 字符串测试
```bash
str1="hello"
str2="world"
str3=""

# 字符串长度测试
[ -z "$str3" ] && echo "字符串为空"
[ -n "$str1" ] && echo "字符串非空"

# 字符串比较
[ "$str1" = "$str2" ] && echo "字符串相等"
[ "$str1" != "$str2" ] && echo "字符串不相等"

# 字典序比较（仅在[[]]中可用）
[[ "$str1" < "$str2" ]] && echo "str1在字典序中小于str2"
[[ "$str1" > "$str2" ]] && echo "str1在字典序中大于str2"
```

### 数值比较
```bash
num1=10
num2=20

[ "$num1" -eq "$num2" ] && echo "相等"
[ "$num1" -ne "$num2" ] && echo "不相等"
[ "$num1" -lt "$num2" ] && echo "小于"
[ "$num1" -le "$num2" ] && echo "小于等于"
[ "$num1" -gt "$num2" ] && echo "大于"
[ "$num1" -ge "$num2" ] && echo "大于等于"
```

## 2. 逻辑运算符

### 基本逻辑运算
```bash
# AND运算
[ condition1 ] && [ condition2 ]
[ condition1 -a condition2 ]  # 不推荐
[[ condition1 && condition2 ]]  # 推荐

# OR运算
[ condition1 ] || [ condition2 ]
[ condition1 -o condition2 ]  # 不推荐
[[ condition1 || condition2 ]]  # 推荐

# NOT运算
[ ! condition ]
[[ ! condition ]]
```

### 复杂条件示例
```bash
#!/bin/bash
age=25
name="张三"

# 复合条件
if [[ $age -ge 18 && $age -le 65 && -n $name ]]; then
    echo "$name 符合工作年龄要求"
fi

# 多重条件
if [[ $age -lt 18 ]]; then
    echo "未成年"
elif [[ $age -ge 18 && $age -lt 60 ]]; then
    echo "成年人"
else
    echo "老年人"
fi
```

## 3. if语句结构

### 基本if语句
```bash
#!/bin/bash
score=85

if [ $score -ge 90 ]; then
    echo "优秀"
elif [ $score -ge 80 ]; then
    echo "良好"
elif [ $score -ge 70 ]; then
    echo "中等"
elif [ $score -ge 60 ]; then
    echo "及格"
else
    echo "不及格"
fi
```

### 嵌套if语句
```bash
#!/bin/bash
read -p "请输入用户名: " username
read -s -p "请输入密码: " password

if [[ -n $username ]]; then
    if [[ ${#password} -ge 8 ]]; then
        if [[ $password =~ [A-Z] && $password =~ [a-z] && $password =~ [0-9] ]]; then
            echo "登录成功"
        else
            echo "密码必须包含大小写字母和数字"
        fi
    else
        echo "密码长度至少8位"
    fi
else
    echo "用户名不能为空"
fi
```

## 4. case语句

### 基本case语句
```bash
#!/bin/bash
read -p "请选择操作 (start/stop/restart/status): " action

case $action in
    start)
        echo "启动服务..."
        ;;
    stop)
        echo "停止服务..."
        ;;
    restart)
        echo "重启服务..."
        ;;
    status)
        echo "查看状态..."
        ;;
    *)
        echo "无效操作: $action"
        echo "可用操作: start, stop, restart, status"
        exit 1
        ;;
esac
```

### 高级case模式
```bash
#!/bin/bash
filename="$1"

case $filename in
    
    
    
    
    |*.text)
        echo "文本文件"
        ;;
    *.jpg|*.jpeg|*.png|*.gif)
        echo "图片文件"
        ;;
    *.mp3|*.wav|*.flac)
        echo "音频文件"
        ;;
    *.mp4|*.avi|*.mkv)
        echo "视频文件"
        ;;
    [Mm]akefile)
        echo "Makefile"
        ;;
    [0-9][0-9][0-9][0-9]-[0-9][0-9]-[0-9][0-9])
        echo "日期格式文件"
        ;;
    *)
        echo "未知文件类型"
        ;;
esac
```

## 5. 正则表达式匹配

### 使用=~操作符
```bash
#!/bin/bash
email="user@example.com"
phone="138-1234-5678"
ip="192.168.1.1"

# 邮箱验证
if [[ $email =~ ^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$ ]]; then
    echo "有效的邮箱地址"
fi

# 手机号验证
if [[ $phone =~ ^1[3-9][0-9]-[0-9]{4}-[0-9]{4}$ ]]; then
    echo "有效的手机号码"
fi

# IP地址验证
if [[ $ip =~ ^([0-9]{1,3}\.){3}[0-9]{1,3}$ ]]; then
    echo "IP地址格式正确"
fi
```

### 提取匹配组
```bash
#!/bin/bash
log_line="2023-12-25 14:30:25 [ERROR] Database connection failed"

if [[ $log_line =~ ^([0-9-]+)\ ([0-9:]+)\ \[([A-Z]+)\]\ (.+)$ ]]; then
    date="${BASH_REMATCH[1]}"
    time="${BASH_REMATCH[2]}"
    level="${BASH_REMATCH[3]}"
    message="${BASH_REMATCH[4]}"
    
    echo "日期: $date"
    echo "时间: $time"
    echo "级别: $level"
    echo "消息: $message"
fi
```

## 6. 条件判断最佳实践

### 安全的条件判断
```bash
#!/bin/bash

# 安全的变量比较
safe_compare() {
    local var1="$1"
    local var2="$2"
    
    # 使用双引号防止变量为空时出错
    if [[ "$var1" == "$var2" ]]; then
        return 0
    else
        return 1
    fi
}

# 安全的数值比较
safe_numeric_compare() {
    local num1="$1"
    local num2="$2"
    
    # 检查是否为数字
    if [[ $num1 =~ ^-?[0-9]+$ ]] && [[ $num2 =~ ^-?[0-9]+$ ]]; then
        if [[ $num1 -eq $num2 ]]; then
            return 0
        fi
    fi
    return 1
}

# 安全的文件操作
safe_file_operation() {
    local file="$1"
    
    if [[ -n "$file" ]] && [[ -f "$file" ]] && [[ -r "$file" ]]; then
        echo "文件 $file 可以安全读取"
        return 0
    else
        echo "文件 $file 不存在或不可读" >&2
        return 1
    fi
}
```

## 实践练习

### 练习1：系统信息检查脚本
```bash
#!/bin/bash
# system_check.sh - 系统健康检查

check_disk_space() {
    local threshold=80
    local usage=$(df / | awk 'NR==2 {print $5}' | sed 's/%//')
    
    if [[ $usage -gt $threshold ]]; then
        echo "警告: 磁盘使用率 ${usage}% 超过阈值 ${threshold}%"
        return 1
    else
        echo "磁盘使用率正常: ${usage}%"
        return 0
    fi
}

check_memory() {
    local threshold=80
    local usage=$(free | awk 'NR==2{printf "%.0f", $3*100/$2}')
    
    if [[ $usage -gt $threshold ]]; then
        echo "警告: 内存使用率 ${usage}% 超过阈值 ${threshold}%"
        return 1
    else
        echo "内存使用率正常: ${usage}%"
        return 0
    fi
}

check_load_average() {
    local threshold=2.0
    local load=$(uptime | awk -F'load average:' '{print $2}' | awk '{print $1}' | sed 's/,//')
    
    if (( $(echo "$load > $threshold" | bc -l) )); then
        echo "警告: 系统负载 $load 超过阈值 $threshold"
        return 1
    else
        echo "系统负载正常: $load"
        return 0
    fi
}

main() {
    echo "=== 系统健康检查 ==="
    echo "检查时间: $(date)"
    echo
    
    local exit_code=0
    
    check_disk_space || exit_code=1
    check_memory || exit_code=1
    check_load_average || exit_code=1
    
    echo
    if [[ $exit_code -eq 0 ]]; then
        echo "✓ 系统状态正常"
    else
        echo "✗ 发现系统问题"
    fi
    
    exit $exit_code
}

main "$@"
```

### 练习2：用户输入验证脚本
```bash
#!/bin/bash
# input_validator.sh - 用户输入验证

validate_email() {
    local email="$1"
    local pattern="^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$"
# 1. ^ - 行开始锚点
# 确保匹配从字符串开头开始
# 防止部分匹配
# 2. [a-zA-Z0-9._%+-]+ - 用户名部分
# [a-zA-Z0-9._%+-] - 字符集合，包含：
# a-z - 小写字母
# A-Z - 大写字母
# 0-9 - 数字
# . - 点号
# _ - 下划线
# % - 百分号
# + - 加号
# - - 减号
# + - 量词，表示前面的字符集至少出现1次
# 3. @ - @ 符号
# 邮箱地址的必需分隔符
# 字面匹配 @ 字符
# 4. [a-zA-Z0-9.-]+ - 域名主体部分
# [a-zA-Z0-9.-] - 字符集合，包含：
# a-z - 小写字母
# A-Z - 大写字母
# 0-9 - 数字
# . - 点号（用于子域名）
# - - 减号
# + - 至少出现1次
# 5. \. - 转义的点号
# \ - 转义字符
# . - 字面意思的点号（不是正则中的"任意字符"）
# 用于分隔域名和顶级域名
# 6. [a-zA-Z]{2,} - 顶级域名部分
# [a-zA-Z] - 只允许字母（大小写）
# {2,} - 量词，表示至少2个字符
# 匹配如：com, org, edu, info 等
# 7. $ - 行结束锚点
# 确保匹配到字符串末尾
# 防止后面还有其他字符
    
    if [[ $email =~ $pattern ]]; then
        return 0
    else
        return 1
    fi
}

validate_phone() {
    local phone="$1"
    local pattern="^1[3-9][0-9]{9}$"
    
    if [[ $phone =~ $pattern ]]; then
        return 0
    else
        return 1
    fi
}

validate_password() {
    local password="$1"
    
    # 检查长度
    if [[ ${#password} -lt 8 ]]; then
        echo "密码长度至少8位"
        return 1
    fi
    
    # 检查是否包含大写字母
    if [[ ! $password =~ [A-Z] ]]; then
        echo "密码必须包含大写字母"
        return 1
    fi
    
    # 检查是否包含小写字母
    if [[ ! $password =~ [a-z] ]]; then
        echo "密码必须包含小写字母"
        return 1
    fi
    
    # 检查是否包含数字
    if [[ ! $password =~ [0-9] ]]; then
        echo "密码必须包含数字"
        return 1
    fi
    
    return 0
}

main() {
    echo "=== 用户注册信息验证 ==="
    
    # 验证邮箱
    while true; do
        read -p "请输入邮箱地址: " email
        if validate_email "$email"; then
            echo "✓ 邮箱格式正确"
            break
        else
            echo "✗ 邮箱格式不正确，请重新输入"
        fi
    done
    
    # 验证手机号
    while true; do
        read -p "请输入手机号码: " phone
        if validate_phone "$phone"; then
            echo "✓ 手机号格式正确"
            break
        else
            echo "✗ 手机号格式不正确，请输入11位手机号"
        fi
    done
    
    # 验证密码
    while true; do
        read -s -p "请输入密码: " password
        echo
        if validate_password "$password"; then
            echo "✓ 密码格式正确"
            break
        else
            echo "✗ 密码不符合要求，请重新输入"
        fi
    done
    
    echo
    echo "✓ 所有信息验证通过！"
}

main "$@"
```

## 调试技巧

1. **使用set -x**：显示执行的每个命令
2. **使用set -e**：遇到错误立即退出
3. **使用set -u**：使用未定义变量时报错
4. **组合使用**：`set -euxo pipefail` 严格模式