# Shell Trap å‘½ä»¤å®ç”¨æ¡ˆä¾‹æ€»ç»“

## ğŸ“‹ æ¡ˆä¾‹æ¦‚è§ˆ

æˆ‘å·²ç»ä¸ºä½ åˆ›å»ºäº†ä¸€å¥—å®Œæ•´çš„Shell trapå‘½ä»¤å®ç”¨æ¡ˆä¾‹ï¼ŒåŒ…å«5ä¸ªæ ¸å¿ƒè„šæœ¬å’Œç›¸å…³æ–‡æ¡£ï¼š

### ğŸ¯ æ ¸å¿ƒè„šæœ¬æ–‡ä»¶

| åºå· | æ–‡ä»¶å | å¤§å° | åŠŸèƒ½æè¿° |
|------|--------|------|----------|
| 1 | `trap_cleanup_demo.sh` | 6.9KB | è„šæœ¬é€€å‡ºæ—¶è‡ªåŠ¨æ¸…ç†ä¸´æ—¶æ–‡ä»¶ |
| 2 | `trap_signal_handler.sh` | 8.9KB | æ•è·ä¸­æ–­ä¿¡å·æ—¶çš„ä¼˜é›…å¤„ç† |
| 3 | `trap_debug_tracer.sh` | 13.6KB | è°ƒè¯•æ—¶è¿½è¸ªå˜é‡çŠ¶æ€å˜åŒ– |
| 4 | `trap_multiprocess_manager.sh` | 19.0KB | å¤šè¿›ç¨‹ç®¡ç†ä¸­çš„ä¿¡å·å¤„ç† |
| 5 | `trap_cron_monitor.sh` | 21.1KB | å®šæ—¶ä»»åŠ¡ä¸­çš„å¼‚å¸¸æ•è· |

### ğŸ“š æ–‡æ¡£æ–‡ä»¶

| æ–‡ä»¶å | åŠŸèƒ½ |
|--------|------|
| `trap_examples_README.md` | è¯¦ç»†ä½¿ç”¨è¯´æ˜å’Œæœ€ä½³å®è·µ |
| `test_all_traps.sh` | è‡ªåŠ¨åŒ–æµ‹è¯•è„šæœ¬ |
| `TRAP_CASES_SUMMARY.md` | æœ¬æ€»ç»“æ–‡æ¡£ |

## ğŸš€ å¿«é€Ÿä½¿ç”¨æŒ‡å—

### åœ¨Linux/macOSç¯å¢ƒä¸‹ï¼š

```bash
# 1. èµ‹äºˆæ‰§è¡Œæƒé™
chmod +x bash_practice/trap_*.sh

# 2. è¿è¡Œå„ä¸ªæ¡ˆä¾‹
./bash_practice/trap_cleanup_demo.sh
./bash_practice/trap_signal_handler.sh
./bash_practice/trap_debug_tracer.sh
./bash_practice/trap_multiprocess_manager.sh 10
./bash_practice/trap_cron_monitor.sh --test

# 3. è¿è¡Œè‡ªåŠ¨åŒ–æµ‹è¯•
./bash_practice/test_all_traps.sh
```

### åœ¨Windows WSLç¯å¢ƒä¸‹ï¼š

```bash
# ç›´æ¥ä½¿ç”¨bashè¿è¡Œ
bash bash_practice/trap_cleanup_demo.sh
bash bash_practice/trap_signal_handler.sh
bash bash_practice/trap_debug_tracer.sh
bash bash_practice/trap_multiprocess_manager.sh 10
bash bash_practice/trap_cron_monitor.sh --test
```

## ğŸ¨ æ¡ˆä¾‹ç‰¹è‰²åŠŸèƒ½

### æ¡ˆä¾‹1: ä¸´æ—¶èµ„æºæ¸…ç† (`trap_cleanup_demo.sh`)
- âœ… è‡ªåŠ¨æ¸…ç†ä¸´æ—¶æ–‡ä»¶å’Œç›®å½•
- âœ… é”æ–‡ä»¶ç®¡ç†é˜²æ­¢é‡å¤è¿è¡Œ
- âœ… å½©è‰²æ—¥å¿—è¾“å‡º
- âœ… æ”¯æŒæ­£å¸¸å’Œå¼‚å¸¸é€€å‡ºæ¸…ç†
- âœ… äº¤äº’å¼æ¼”ç¤ºæ¨¡å¼

**æ ¸å¿ƒtrapç”¨æ³•**:
```bash
trap cleanup EXIT
```

### æ¡ˆä¾‹2: ä¿¡å·å¤„ç† (`trap_signal_handler.sh`)
- âœ… å¤„ç†å¤šç§ç³»ç»Ÿä¿¡å· (INT, TERM, USR1, USR2, HUP)
- âœ… ä¼˜é›…å…³é—­é•¿æ—¶é—´è¿è¡Œçš„ä»»åŠ¡
- âœ… å®æ—¶çŠ¶æ€æŠ¥å‘Š
- âœ… é…ç½®é‡è½½åŠŸèƒ½
- âœ… è¿›ç¨‹ç›‘æ§å’Œç®¡ç†

**æ ¸å¿ƒtrapç”¨æ³•**:
```bash
trap handle_sigint INT
trap handle_sigterm TERM
trap handle_sigusr1 USR1
```

### æ¡ˆä¾‹3: è°ƒè¯•è¿½è¸ª (`trap_debug_tracer.sh`)
- âœ… ä½¿ç”¨ `trap DEBUG` è¿½è¸ªæ¯ä¸ªå‘½ä»¤æ‰§è¡Œ
- âœ… ç›‘æ§å˜é‡å€¼å˜åŒ–è¿‡ç¨‹
- âœ… ç»Ÿè®¡å‡½æ•°è°ƒç”¨å’Œæ€§èƒ½æ•°æ®
- âœ… äº¤äº’å¼è°ƒè¯•æ§åˆ¶èœå•
- âœ… å¯é…ç½®çš„è°ƒè¯•çº§åˆ«

**æ ¸å¿ƒtrapç”¨æ³•**:
```bash
trap debug_tracer DEBUG
```

### æ¡ˆä¾‹4: å¤šè¿›ç¨‹ç®¡ç† (`trap_multiprocess_manager.sh`)
- âœ… ç®¡ç†å¤šä¸ªå·¥ä½œè¿›ç¨‹çš„ç”Ÿå‘½å‘¨æœŸ
- âœ… ä»»åŠ¡é˜Ÿåˆ—è°ƒåº¦å’Œåˆ†é…
- âœ… è¿›ç¨‹ç›‘æ§å’Œè‡ªåŠ¨é‡å¯
- âœ… ä¼˜é›…å…³é—­æ‰€æœ‰å­è¿›ç¨‹
- âœ… å®æ—¶çŠ¶æ€ç›‘æ§

**æ ¸å¿ƒtrapç”¨æ³•**:
```bash
trap graceful_shutdown TERM INT
trap status_report USR1
```

### æ¡ˆä¾‹5: å®šæ—¶ä»»åŠ¡ç›‘æ§ (`trap_cron_monitor.sh`)
- âœ… é€‚ç”¨äºcronç¯å¢ƒçš„å¼‚å¸¸å¤„ç†
- âœ… ä»»åŠ¡æ‰§è¡Œé‡è¯•æœºåˆ¶
- âœ… èµ„æºç›‘æ§å’Œå‘Šè­¦é€šçŸ¥
- âœ… æ‰§è¡Œé”é˜²æ­¢é‡å¤è¿è¡Œ
- âœ… è¯¦ç»†çš„é”™è¯¯æ—¥å¿—å’ŒæŒ‡æ ‡è®°å½•

**æ ¸å¿ƒtrapç”¨æ³•**:
```bash
trap 'handle_error $LINENO' ERR
trap handle_interrupt INT
trap 'LAST_COMMAND=$BASH_COMMAND' DEBUG
```

## ğŸ› ï¸ æŠ€æœ¯äº®ç‚¹

### 1. å®Œæ•´çš„é”™è¯¯å¤„ç†æœºåˆ¶
æ¯ä¸ªè„šæœ¬éƒ½åŒ…å«äº†å®Œå–„çš„é”™è¯¯å¤„ç†ï¼š
- è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯è®°å½•
- è°ƒç”¨æ ˆè¿½è¸ª
- è‡ªåŠ¨å‘Šè­¦é€šçŸ¥
- èµ„æºæ¸…ç†ä¿è¯

### 2. ç”Ÿäº§çº§åˆ«çš„åŠŸèƒ½
- è¿›ç¨‹é”é˜²æ­¢é‡å¤è¿è¡Œ
- è¶…æ—¶ç›‘æ§å’Œå¼ºåˆ¶ç»ˆæ­¢
- èµ„æºä½¿ç”¨ç›‘æ§
- æ—¥å¿—è½®è½¬å’Œç®¡ç†
- é…ç½®æ–‡ä»¶æ”¯æŒ

### 3. ç”¨æˆ·å‹å¥½çš„è®¾è®¡
- å½©è‰²è¾“å‡ºä¾¿äºè§‚å¯Ÿ
- è¯¦ç»†çš„å¸®åŠ©ä¿¡æ¯
- äº¤äº’å¼æ“ä½œç•Œé¢
- è¿›åº¦æ˜¾ç¤ºå’ŒçŠ¶æ€æŠ¥å‘Š

### 4. é«˜åº¦å¯é…ç½®
- ç¯å¢ƒå˜é‡æ§åˆ¶è¡Œä¸º
- å‘½ä»¤è¡Œå‚æ•°æ”¯æŒ
- é…ç½®æ–‡ä»¶è¯»å–
- è¿è¡Œæ—¶å‚æ•°è°ƒæ•´

## ğŸ“Š ä½¿ç”¨åœºæ™¯æ˜ å°„

| ä½¿ç”¨åœºæ™¯ | æ¨èè„šæœ¬ | å…³é”®ç‰¹æ€§ |
|----------|----------|----------|
| æ•°æ®å¤„ç†è„šæœ¬ | `trap_cleanup_demo.sh` | ä¸´æ—¶æ–‡ä»¶æ¸…ç† |
| WebæœåŠ¡ç®¡ç† | `trap_signal_handler.sh` | ä¼˜é›…å…³é—­ |
| è„šæœ¬è°ƒè¯• | `trap_debug_tracer.sh` | æ‰§è¡Œè¿½è¸ª |
| æ‰¹é‡å¤„ç† | `trap_multiprocess_manager.sh` | å¹¶è¡Œæ‰§è¡Œ |
| ç³»ç»Ÿç»´æŠ¤ | `trap_cron_monitor.sh` | å®šæ—¶ä»»åŠ¡ |
| ç›‘æ§è„šæœ¬ | `trap_signal_handler.sh` + `trap_cron_monitor.sh` | ä¿¡å·å¤„ç†+ç›‘æ§ |
| å¤‡ä»½è„šæœ¬ | `trap_cleanup_demo.sh` + `trap_cron_monitor.sh` | æ¸…ç†+é‡è¯• |

## ğŸ¯ å­¦ä¹ è·¯å¾„å»ºè®®

### åˆå­¦è€…è·¯å¾„ï¼š
1. **å¼€å§‹**: `trap_cleanup_demo.sh` - å­¦ä¹ åŸºç¡€çš„EXIT trap
2. **è¿›é˜¶**: `trap_signal_handler.sh` - ç†è§£ä¿¡å·å¤„ç†
3. **æ·±å…¥**: `trap_debug_tracer.sh` - æŒæ¡DEBUG trap

### è¿›é˜¶ç”¨æˆ·è·¯å¾„ï¼š
1. **å¹¶å‘**: `trap_multiprocess_manager.sh` - å¤šè¿›ç¨‹ç®¡ç†
2. **ç”Ÿäº§**: `trap_cron_monitor.sh` - ç”Ÿäº§ç¯å¢ƒåº”ç”¨
3. **é›†æˆ**: ç»„åˆä½¿ç”¨å¤šä¸ªæ¡ˆä¾‹çš„æŠ€æœ¯

## ğŸ”§ è‡ªå®šä¹‰å’Œæ‰©å±•

### æ·»åŠ æ–°çš„ä¿¡å·å¤„ç†
```bash
# åœ¨ç°æœ‰è„šæœ¬åŸºç¡€ä¸Šæ·»åŠ 
trap handle_custom_signal USR2

handle_custom_signal() {
    echo "å¤„ç†è‡ªå®šä¹‰ä¿¡å·..."
    # ä½ çš„é€»è¾‘
}
```

### æ‰©å±•æ¸…ç†åŠŸèƒ½
```bash
# æ‰©å±•æ¸…ç†å‡½æ•°
cleanup() {
    # åŸæœ‰æ¸…ç†é€»è¾‘
    cleanup_temp_files
    
    # æ·»åŠ æ–°çš„æ¸…ç†é€»è¾‘
    cleanup_database_connections
    cleanup_network_resources
}
```

### é›†æˆåˆ°ç°æœ‰é¡¹ç›®
```bash
# åœ¨ä½ çš„è„šæœ¬ä¸­å¼•ç”¨è¿™äº›æ¡ˆä¾‹çš„å‡½æ•°
source "bash_practice/trap_cleanup_demo.sh"

# ä½¿ç”¨å…¶ä¸­çš„å‡½æ•°
create_temp_file "myproject"
```

## ğŸ“ˆ æ€§èƒ½è€ƒè™‘

### DEBUG trapçš„æ€§èƒ½å½±å“
- DEBUG trapä¼šåœ¨æ¯ä¸ªå‘½ä»¤å‰æ‰§è¡Œï¼Œå½±å“æ€§èƒ½
- ç”Ÿäº§ç¯å¢ƒå»ºè®®ä½¿ç”¨æ¡ä»¶æ§åˆ¶ï¼š
```bash
if [[ ${DEBUG_MODE:-0} -eq 1 ]]; then
    trap debug_tracer DEBUG
fi
```

### å¤šè¿›ç¨‹ç®¡ç†çš„èµ„æºæ¶ˆè€—
- ç›‘æ§è¿›ç¨‹æ•°é‡å’Œå†…å­˜ä½¿ç”¨
- åˆç†è®¾ç½®æœ€å¤§å·¥ä½œè¿›ç¨‹æ•°
- å®ç°è¿›ç¨‹æ± å¤ç”¨æœºåˆ¶

## ğŸš¨ æ³¨æ„äº‹é¡¹

1. **ä¿¡å·å¤„ç†é™åˆ¶**ï¼š
   - SIGKILL (9) å’Œ SIGSTOP (19) æ— æ³•è¢«æ•è·
   - ä¿¡å·å¤„ç†å‡½æ•°åº”è¯¥ç®€æ´å¿«é€Ÿ

2. **EXIT trapç‰¹æ€§**ï¼š
   - åœ¨è„šæœ¬é€€å‡ºæ—¶æ€»æ˜¯æ‰§è¡Œ
   - ä¸è¦åœ¨EXIT trapä¸­è°ƒç”¨exitå‘½ä»¤

3. **å¤šè¿›ç¨‹ç¯å¢ƒ**ï¼š
   - å­è¿›ç¨‹ä¸ç»§æ‰¿çˆ¶è¿›ç¨‹çš„trapè®¾ç½®
   - éœ€è¦åœ¨å­è¿›ç¨‹ä¸­é‡æ–°è®¾ç½®trap

4. **Windowså…¼å®¹æ€§**ï¼š
   - æŸäº›ä¿¡å·åœ¨Windowsä¸‹ä¸å¯ç”¨
   - å»ºè®®åœ¨WSLæˆ–Git Bashä¸­è¿è¡Œ

## ğŸ‰ æ€»ç»“

è¿™å¥—trapæ¡ˆä¾‹é›†åˆæä¾›äº†ï¼š

- **5ä¸ªå®Œæ•´çš„å®ç”¨è„šæœ¬** - æ¶µç›–ä¸åŒåº”ç”¨åœºæ™¯
- **è¯¦ç»†çš„æ–‡æ¡£è¯´æ˜** - åŒ…å«ä½¿ç”¨æ–¹æ³•å’Œæœ€ä½³å®è·µ  
- **è‡ªåŠ¨åŒ–æµ‹è¯•å·¥å…·** - éªŒè¯è„šæœ¬åŠŸèƒ½æ­£ç¡®æ€§
- **ç”Ÿäº§çº§åˆ«çš„ä»£ç è´¨é‡** - åŒ…å«é”™è¯¯å¤„ç†ã€æ—¥å¿—è®°å½•ã€ç›‘æ§ç­‰

é€šè¿‡å­¦ä¹ å’Œä½¿ç”¨è¿™äº›æ¡ˆä¾‹ï¼Œä½ å¯ä»¥ï¼š
- æŒæ¡trapå‘½ä»¤çš„å„ç§ç”¨æ³•
- å­¦ä¼šç¼–å†™å¥å£®çš„Shellè„šæœ¬
- äº†è§£ç”Ÿäº§ç¯å¢ƒçš„æœ€ä½³å®è·µ
- è·å¾—å¯ç›´æ¥ä½¿ç”¨çš„ä»£ç æ¨¡æ¿

å¸Œæœ›è¿™äº›æ¡ˆä¾‹èƒ½å¸®åŠ©ä½ åœ¨Shellè„šæœ¬å¼€å‘ä¸­æ›´å¥½åœ°ä½¿ç”¨trapå‘½ä»¤ï¼

---

**åˆ›å»ºæ—¶é—´**: 2025å¹´9æœˆ22æ—¥  
**è„šæœ¬æ€»æ•°**: 7ä¸ªæ–‡ä»¶  
**ä»£ç æ€»é‡**: çº¦70KB  
**æµ‹è¯•è¦†ç›–**: åŒ…å«è‡ªåŠ¨åŒ–æµ‹è¯•  
**æ–‡æ¡£å®Œæ•´æ€§**: 100%